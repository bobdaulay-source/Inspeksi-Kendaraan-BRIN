<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikasi Web – Form Inspeksi Kendaraan</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --brand:#22c55e; --bad:#ef4444; --na:#64748b; --accent:#06b6d4; }
    *{box-sizing:border-box} body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
    .container{max-width:1100px; margin:24px auto; padding:16px}
    .card{background:linear-gradient(180deg,#0b1022, #0b1329); border:1px solid #1f2937; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
    header{padding:20px 24px; border-bottom:1px solid #1f2937; display:flex; gap:12px; align-items:center; justify-content:space-between}
    header h1{font-size:18px; margin:0}
    header small{color:var(--muted)}
    .grid{display:grid; gap:12px}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .section{padding:16px 24px; border-bottom:1px solid #1f2937}
    .section h2{margin:0 0 12px; font-size:16px}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #223046; background:#0b1324; color:#e5e7eb}
    textarea{min-height:90px; resize:vertical}
    .row{display:flex; align-items:center; gap:10px}
    .btns{display:flex; flex-wrap:wrap; gap:10px}
    button{padding:10px 14px; border:1px solid #223046; border-radius:10px; background:#0b1324; color:#e5e7eb; cursor:pointer}
    button.primary{background:linear-gradient(180deg,#10b981,#059669); border-color:#065f46}
    button.warn{background:linear-gradient(180deg,#ef4444,#b91c1c); border-color:#7f1d1d}
    button.ghost{background:#0b1324}
    .status-pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #223046}
    .pill-g{background:#052e1a; color:#86efac}
    .pill-b{background:#3b0a0a; color:#fecaca}
    .pill-na{background:#0b1324; color:#cbd5e1}
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th,td{padding:8px 10px; font-size:13px}
    thead th{color:#93c5fd; text-align:left}
    tr.item{background:#0b1324; border:1px solid #223046}
    tr.item td{border-top:1px solid #223046; border-bottom:1px solid #223046}
    tr.item td:first-child{border-left:1px solid #223046; border-top-left-radius:10px; border-bottom-left-radius:10px}
    tr.item td:last-child{border-right:1px solid #223046; border-top-right-radius:10px; border-bottom-right-radius:10px}
    .choices{display:flex; gap:10px}
    .choices label{margin:0; color:#e5e7eb}
    .choices input{margin-right:6px}
    .sub{font-size:12px; color:var(--muted)}
    .footer{padding:16px 24px; display:flex; justify-content:space-between; align-items:center}
    .muted{color:var(--muted)}
    .note{font-size:12px; color:#9ca3af}
    @media(max-width:800px){.g-2,.g-3{grid-template-columns:1fr}}
    @media print { body{background:#fff; color:#000} .card{box-shadow:none; border:1px solid #888} header, .btns{display:none} input,select,textarea{border:1px solid #bbb; background:#fff; color:#000}
      .section{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="app">
      <header>
        <div>
          <h1>Formulir Inspeksi Kendaraan</h1>
          <small>Biro Komunikasi, Publikasi Umum, dan Kesekretariatan</small>
        </div>
        <div class="btns">
          <button class="primary" onclick="saveLocal()">Simpan Lokal</button>
          <button class="ghost" onclick="loadLocal()">Muat</button>
          <button class="ghost" onclick="exportJSON()">Ekspor JSON</button>
          <button class="ghost" onclick="exportCSV()">Ekspor CSV</button>
          <button class="ghost" onclick="exportPDF()">Ekspor PDF</button>
          <button onclick="window.print()">Cetak/PDF</button>
          <button class="warn" onclick="resetForm()">Reset</button>
        </div>
      </header>

      <div class="section">
        <h2>Identitas Kendaraan</h2>
        <div class="grid g-3">
          <div>
            <label>Nama Pengemudi</label>
            <input id="driver" placeholder="Junaedi" />
          </div>
          <div>
            <label>Nomor Polisi</label>
            <input id="plate" placeholder="B 7057 SPA" />
          </div>
          <div>
            <label>Tanggal Inspeksi</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>KM Awal</label>
            <input id="km_start" type="number" min="0" />
          </div>
          <div>
            <label>KM Akhir</label>
            <input id="km_end" type="number" min="0" />
          </div>
          <div>
            <label>Jenis Kendaraan</label>
            <input id="type" placeholder="MPV / Sedan / Minibus" />
          </div>
          <div>
            <label>Tahun Kendaraan</label>
            <input id="year" type="number" min="1990" max="2100" />
          </div>
          <div>
            <label>Start Inspeksi (jam)</label>
            <input id="start_time" type="time" />
          </div>
          <div>
            <label>Finish (jam)</label>
            <input id="end_time" type="time" />
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Checklist</h2>
        <div class="note">Pilih G untuk Good, B untuk Bad, N/A bila tidak ada.</div>
        <table>
          <thead>
            <tr><th style="width:44%">Item</th><th style="width:18%">G</th><th style="width:18%">B</th><th style="width:18%">N/A</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="row" style="margin-top:8px; gap:16px">
          <span class="status-pill pill-g" id="cnt_g">Good: 0</span>
          <span class="status-pill pill-b" id="cnt_b">Bad: 0</span>
          <span class="status-pill pill-na" id="cnt_na">N/A: 0</span>
        </div>
      </div>

      <div class="section">
        <h2>Catatan</h2>
        <textarea id="notes" placeholder="Tulis temuan, saran perbaikan, atau catatan lain"></textarea>
      </div>

      <div class="footer">
        <div class="grid g-2" style="width:100%">
          <div>
            <label>Nama Pengemudi (Tanda Tangan di Kertas)</label>
            <input id="sign_driver" placeholder="Nama jelas pengemudi" />
          </div>
          <div>
            <label>Nama Pemeriksa</label>
            <input id="sign_inspector" placeholder="Nama jelas pemeriksa" />
          </div>
        </div>
        <div class="muted">Versi offline, data tersimpan di peramban perangkat ini.</div>
      </div>
    </div>
  </div>

<!-- Libraries for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  const ITEMS = [
    { id:"sim", label:"SIM" },
    { id:"stnk", label:"STNK" },
    { id:"rfid", label:"Kartu RFID" },
    { id:"p3k", label:"P3K" },
    { id:"plat_depan", label:"Plat Nomor Depan" },
    { id:"plat_belakang", label:"Plat Nomor Belakang" },
    { id:"lampu_besar_dekat_kanan", label:"Lampu Besar Dekat – Kanan" },
    { id:"lampu_besar_dekat_kiri", label:"Lampu Besar Dekat – Kiri" },
    { id:"lampu_besar_jauh_kanan", label:"Lampu Besar Jauh – Kanan" },
    { id:"lampu_besar_jauh_kiri", label:"Lampu Besar Jauh – Kiri" },
    { id:"sen_depan_kanan", label:"Lampu Sen Depan – Kanan" },
    { id:"sen_depan_kiri", label:"Lampu Sen Depan – Kiri" },
    { id:"sen_belakang_kanan", label:"Lampu Sen Belakang – Kanan" },
    { id:"sen_belakang_kiri", label:"Lampu Sen Belakang – Kiri" },
    { id:"lampu_rem_kanan", label:"Lampu Rem – Kanan" },
    { id:"lampu_rem_kiri", label:"Lampu Rem – Kiri" },
    { id:"lampu_mundur_kanan", label:"Lampu Mundur – Kanan" },
    { id:"lampu_mundur_kiri", label:"Lampu Mundur – Kiri" },
    { id:"lampu_hazard_kiri", label:"Lampu Hazard – Kiri" },
    { id:"lampu_hazard_kanan", label:"Lampu Hazard – Kanan" },
    { id:"klakson", label:"Klakson" },
    { id:"ban_depan_kanan", label:"Kondisi Ban – Depan Kanan" },
    { id:"ban_depan_kiri", label:"Kondisi Ban – Depan Kiri" },
    { id:"ban_belakang_kanan", label:"Kondisi Ban – Belakang Kanan" },
    { id:"ban_belakang_kiri", label:"Kondisi Ban – Belakang Kiri" },
    { id:"ban_serep", label:"Kondisi Ban – Serep" },
    { id:"kunci_roda", label:"Kunci Roda" },
    { id:"dongkrak", label:"Dongkrak" },
    { id:"spion_kanan", label:"Kaca Spion – Kanan" },
    { id:"spion_kiri", label:"Kaca Spion – Kiri" },
    { id:"spion_dalam", label:"Kaca Spion – Dalam" },
    { id:"wiper_kanan", label:"Wiper – Kanan" },
    { id:"wiper_kiri", label:"Wiper – Kiri" },
    { id:"air_wiper", label:"Air Wiper" },
    { id:"body", label:"Kondisi Body" },
    { id:"minyak_rem", label:"Minyak Rem" },
    { id:"kondisi_rem", label:"Kondisi Rem" },
    { id:"oli_mesin", label:"Oli Mesin" },
    { id:"air_radiator", label:"Air Radiator" },
    { id:"air_accu", label:"Air Accu" },
    { id:"ac", label:"Kondisi AC" }
  ];

  const tbody = document.getElementById('tbody');

  function row(item){
    const tr = document.createElement('tr');
    tr.className = 'item';

    const tdLabel = document.createElement('td');
    tdLabel.textContent = item.label;

    const tdG = document.createElement('td');
    const tdB = document.createElement('td');
    const tdNA = document.createElement('td');

    tdG.appendChild(choice(item.id,'G'));
    tdB.appendChild(choice(item.id,'B'));
    tdNA.appendChild(choice(item.id,'NA'));

    tr.appendChild(tdLabel); tr.appendChild(tdG); tr.appendChild(tdB); tr.appendChild(tdNA);
    return tr;
  }

  function choice(id, val){
    const lbl = document.createElement('label');
    lbl.className = 'choices';
    const input = document.createElement('input');
    input.type = 'radio';
    input.name = id;
    input.value = val;
    input.addEventListener('change', updateCounters);
    const span = document.createElement('span');
    span.textContent = val;
    lbl.appendChild(input); lbl.appendChild(span);
    return lbl;
  }

  ITEMS.forEach(i => tbody.appendChild(row(i)));

  function getData(){
    const data = {
      meta: {
        driver: g('driver').value,
        plate: g('plate').value,
        date: g('date').value,
        km_start: g('km_start').value,
        km_end: g('km_end').value,
        type: g('type').value,
        year: g('year').value,
        start_time: g('start_time').value,
        end_time: g('end_time').value
      },
      checklist: {},
      notes: g('notes').value,
      sign_driver: g('sign_driver').value,
      sign_inspector: g('sign_inspector').value
    };
    ITEMS.forEach(i=>{
      const sel = document.querySelector(`input[name="${i.id}"]:checked`);
      data.checklist[i.id] = sel ? sel.value : '';
    });
    return data;
  }

  function setData(data){
    if(!data) return;
    const m = data.meta||{};
    g('driver').value = m.driver||'';
    g('plate').value = m.plate||'';
    g('date').value = m.date||'';
    g('km_start').value = m.km_start||'';
    g('km_end').value = m.km_end||'';
    g('type').value = m.type||'';
    g('year').value = m.year||'';
    g('start_time').value = m.start_time||'';
    g('end_time').value = m.end_time||'';

    (data.checklist ? Object.entries(data.checklist) : []).forEach(([k,v])=>{
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    });
    g('notes').value = data.notes||'';
    g('sign_driver').value = data.sign_driver||'';
    g('sign_inspector').value = data.sign_inspector||'';
    updateCounters();
  }

  function updateCounters(){
    let gCount=0,bCount=0,naCount=0;
    ITEMS.forEach(i=>{
      const sel = document.querySelector(`input[name="${i.id}"]:checked`);
      if(!sel) return;
      if(sel.value==='G') gCount++; else if(sel.value==='B') bCount++; else if(sel.value==='NA') naCount++;
    });
    document.getElementById('cnt_g').textContent = `Good: ${gCount}`;
    document.getElementById('cnt_b').textContent = `Bad: ${bCount}`;
    document.getElementById('cnt_na').textContent = `N/A: ${naCount}`;
  }

  function saveLocal(){
    const data = getData();
    localStorage.setItem('inspeksi_kendaraan', JSON.stringify(data));
    toast('Data tersimpan di perangkat ini.');
  }
  function loadLocal(){
    const raw = localStorage.getItem('inspeksi_kendaraan');
    if(!raw){ toast('Belum ada data tersimpan.'); return; }
    setData(JSON.parse(raw));
    toast('Data termuat.');
  }
  function resetForm(){
    if(!confirm('Kosongkan semua isian?')) return;
    document.querySelectorAll('input, textarea, select').forEach(el=>{
      if(el.type==='radio') el.checked=false; else el.value='';
    });
    updateCounters();
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(getData(),null,2)], {type:'application/json'});
    download(blob, fn('json'));
  }
  function exportCSV(){
    const d = getData();
    const flat = [];
    flat.push(['driver', d.meta.driver]);
    flat.push(['plate', d.meta.plate]);
    flat.push(['date', d.meta.date]);
    flat.push(['km_start', d.meta.km_start]);
    flat.push(['km_end', d.meta.km_end]);
    flat.push(['type', d.meta.type]);
    flat.push(['year', d.meta.year]);
    flat.push(['start_time', d.meta.start_time]);
    flat.push(['end_time', d.meta.end_time]);
    ITEMS.forEach(i=>flat.push([i.id, d.checklist[i.id]||'']))
    flat.push(['notes', JSON.stringify(d.notes||'')]);
    flat.push(['sign_driver', d.sign_driver||'']);
    flat.push(['sign_inspector', d.sign_inspector||'']);
    const csv = flat.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    download(new Blob([csv],{type:'text/csv'}), fn('csv'));
  }

  async function exportPDF(){
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){ alert('Gagal memuat jsPDF. Periksa koneksi internet.'); return; }
    const card = document.getElementById('app');

    updateCounters();

    const scale = 2;
    const canvas = await html2canvas(card, { scale, backgroundColor: '#ffffff' });

    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const pxToMm = px => px * 0.264583;
    const imgWidth = pxToMm(canvas.width);
    const imgHeight = pxToMm(canvas.height);

    const scaleFactor = pageWidth / imgWidth;
    const renderWidth = pageWidth;
    const renderHeight = imgHeight * scaleFactor;

    let remainingHeight = renderHeight;
    const canvasPage = document.createElement('canvas');
    const ctx = canvasPage.getContext('2d');

    const pageHeightPx = pageHeight / 0.264583 / scaleFactor;
    let pageNumber = 0;

    while (remainingHeight > 0) {
      const startYpx = pageNumber * pageHeightPx * 2;
      const sliceHeightPx = Math.min(pageHeightPx * 2, canvas.height - startYpx);

      canvasPage.width = canvas.width;
      canvasPage.height = sliceHeightPx;
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvasPage.width, canvasPage.height);
      ctx.drawImage(canvas, 0, -startYpx);

      const img = canvasPage.toDataURL('image/png');
      if (pageNumber > 0) pdf.addPage();
      pdf.addImage(img, 'PNG', 0, 0, renderWidth, Math.min(pageHeight, sliceHeightPx * 0.264583 * scaleFactor));

      remainingHeight -= pageHeight;
      pageNumber += 1;
    }

    const filename = fn('pdf');
    pdf.save(filename);
  }

  function fn(ext){
    const plate = g('plate').value || 'nopol';
    const date = g('date').value || new Date().toISOString().slice(0,10);
    return `inspeksi_${plate}_${date}.${ext}`;
  }
  function download(blob, filename){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 5000);
  }
  function g(id){ return document.getElementById(id); }

  let toastTimer;
  function toast(msg){
    clearTimeout(toastTimer);
    let t = document.getElementById('toast');
    if(!t){ t = document.createElement('div'); t.id='toast'; document.body.appendChild(t); }
    t.textContent = msg;
    Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'#0b1324',border:'1px solid #223046',padding:'10px 14px',borderRadius:'10px',color:'#e5e7eb',zIndex:9999,boxShadow:'0 6px 20px rgba(0,0,0,.35)'});
    toastTimer = setTimeout(()=>{ t.remove(); }, 1800);
  }

  g('driver').value = 'Junaedi';
  g('plate').value = 'B 7057 SPA';
</script>
</body>
</html>
